
<!DOCTYPE html>
<html>
<head>
    <title>Better hashing - Clojure Design - Clojure Development</title>

        

                        
    

            <meta http-equiv="X-UA-Compatible" content="IE=EDGE">
<meta charset="UTF-8">
<!-- Deprecated since 3.4. To be removed in a future version of Confluence; use AJS.Confluence.getContextPath() -->
<meta id="confluence-context-path" name="confluence-context-path" content="">
<meta id="confluence-base-url" name="confluence-base-url" content="https://dev.clojure.org">

<meta id="atlassian-token" name="atlassian-token" content="30041c830a95ce9c95d0b58cb377def6b96aa6d2">

<meta id="confluence-space-key" name="confluence-space-key" content="design">
<script type="text/javascript">
    // Deprecated global variables. To be removed in a future version of Confluence.
    var contextPath = '';
</script>

    

<!-- include system css resources -->


    <link type="text/css" rel="stylesheet" href="../../s/en_GB/3047/3/55/_/download/superbatch/css/batch.css" media="all">
<!--[if lt IE 9]>
<link type="text/css" rel="stylesheet" href="/s/en_GB/3047/3/55/_/download/superbatch/css/batch.css?conditionalComment=lt+IE+9" media="all">
<![endif]-->
<!--[if IE 9]>
<link type="text/css" rel="stylesheet" href="/s/en_GB/3047/3/55/_/download/superbatch/css/batch.css?conditionalComment=IE+9" media="all">
<![endif]-->
<!--[if lte IE 9]>
<link type="text/css" rel="stylesheet" href="/s/en_GB/3047/3/55/_/download/superbatch/css/batch.css?conditionalComment=lte+IE+9" media="all">
<![endif]-->
<link type="text/css" rel="stylesheet" href="../../s/en_GB/3047/3/55/_/download/superbatch/css/batch-media=print.css" media="print">
<!--[if lt IE 9]>
<link type="text/css" rel="stylesheet" href="/s/en_GB/3047/3/961a0823b948d2f215d5a69c25b0d622/_/download/contextbatch/css/page/batch.css?conditionalComment=lt+IE+9" media="all">
<![endif]-->
<link type="text/css" rel="stylesheet" href="../../s/en_GB/3047/3/961a0823b948d2f215d5a69c25b0d622/_/download/contextbatch/css/page/batch.css" media="all">
<!--[if lt IE 9]>
<link type="text/css" rel="stylesheet" href="/s/en_GB/3047/3/c80b4ecc4b1853e829650e7c54066b66/_/download/contextbatch/css/viewcontent,main/batch.css?conditionalComment=lt+IE+9" media="all">
<![endif]-->
<link type="text/css" rel="stylesheet" href="../../s/en_GB/3047/3/c80b4ecc4b1853e829650e7c54066b66/_/download/contextbatch/css/viewcontent,main/batch.css" media="all">
<link type="text/css" rel="stylesheet" href="../../s/en_GB/3047/3/2.0.1/_/download/batch/com.atlassian.confluence.plugins.pagetree-pagetree-resources/com.atlassian.confluence.plugins.pagetree-pagetree-resources.css" media="all">
<link type="text/css" rel="stylesheet" href="../../s/en_GB/3047/3/3/_/styles/colors-spaceKey=design.css" media="all">
<link type="text/css" rel="stylesheet" href="../../s/en_GB/3047/3/2.0.5/_/download/resources/com.atlassian.confluence.plugins.doctheme-documentation/default-theme.css" media="all">
<link type="text/css" rel="stylesheet" href="../../s/en_GB/3047/3/2.0.5/_/download/resources/com.atlassian.confluence.plugins.doctheme-documentation/splitter.css" media="all">

<!-- end system css resources -->

    <meta name="confluence-request-time" content="1556129046827">
            <meta name="ajs-page-id" content="8192765">
            <meta name="ajs-parent-page-id" content="9142387">
            <meta name="ajs-space-key" content="design">
            <meta name="ajs-space-name" content="Clojure Design">
            <meta name="ajs-page-title" content="Better hashing">
            <meta name="ajs-parent-page-title" content="Release 1.6">
            <meta name="ajs-from-page-title" content="">
            <meta name="ajs-context-path" content="">
            <meta name="ajs-version-number" content="4.0">
            <meta name="ajs-build-number" content="3047">
            <meta name="ajs-remote-user" content="">
            <meta name="ajs-static-resource-url-prefix" content="/s/en_GB/3047/3/_">
            <meta name="ajs-global-settings-attachment-max-size" content="10485760">
            <meta name="ajs-user-locale" content="en_GB">
            <meta name="ajs-enabled-dark-features" content="">
            <meta name="ajs-atl-token" content="30041c830a95ce9c95d0b58cb377def6b96aa6d2">
            
            <meta name="ajs-keyboardshortcut-hash" content="7b95af54c6deada096af1f28fdd0f413">
            <meta name="ajs-use-keyboard-shortcuts" content="true">
    <!-- Deprecated since 3.4. To be removed in a future version of Confluence; use atl.header -->
        
            <script type="text/x-template" title="share-content-popup">
    <form action="#" method="post" class="aui share-content-popup">
        <fieldset>
            <label for="users">User name or email</label>
            <div class="autocomplete-user-target">
                <input class="text autocomplete-sharepage" id="users" data-max="10" data-dropdown-target=".autocomplete-user-target" data-none-message="No matching user or email found"/>
            </div>
            <ol class="recipients">
            </ol>
            <div><label for="note">Note</label></div>
            <textarea class="textarea" id="note" placeholder="Add an optional note"/>
        </fieldset>
        <div class="button-panel">
            <div class="progress-messages-icon"></div>
            <div class="progress-messages">
            </div>
            <input class="button submit" type="submit" value="Share" disabled/>
            <a class="close-dialog" href="#">Cancel</a>
        </div>
    </form>
</script>

<script type="text/x-template" title="share-content-popup-recipient-username">
    <li data-username="{username}" style="display: none">
        <span>
            <img src="{thumbnailLink.href}" title="{title}">
            <span>{title}</span>
            <span class="remove-recipient"/>
        </span>
    </li>
</script>

<script type="text/x-template" title="share-content-popup-recipient-email">
    <li data-email="{email}" style="display: none">
        <span>
            <img src="{icon}" title="{email}">
            <span>{email}</span>
            <span class="remove-recipient"/>
        </span>
    </li>
</script>
    
    <link rel="shortcut icon" href="../../favicon.ico">
    <link rel="icon" type="image/png" href="../../s/en_GB/3047/3/_/images/logo/confluence_16.png">

<link rel="search" type="application/opensearchdescription+xml" href="../../opensearch/osd.action.xml" title="Clojure Development"/>

        <!-- include system javascript resources -->
                        
    
    <script type="text/javascript" src="../../s/en_GB/3047/3/55/_/download/superbatch/js/batch.js" ></script>
<!--[if lte IE 8]>
<script type="text/javascript" src="/s/en_GB/3047/3/55/_/download/superbatch/js/batch.js?conditionalComment=lte+IE+8" ></script>
<![endif]-->
<script type="text/javascript" src="../../s/en_GB/3047/3/961a0823b948d2f215d5a69c25b0d622/_/download/contextbatch/js/page/batch.js" ></script>
<script type="text/javascript" src="../../s/en_GB/3047/3/c80b4ecc4b1853e829650e7c54066b66/_/download/contextbatch/js/viewcontent,main/batch.js" ></script>
<script type="text/javascript" src="../../s/en_GB/3047/3/2.0.1/_/download/batch/com.atlassian.confluence.plugins.pagetree-pagetree-resources/com.atlassian.confluence.plugins.pagetree-pagetree-resources.js" ></script>

    
    <!-- end system javascript resources -->

    

    
    <link rel="canonical" href="Better+hashing.html">
    <link rel="shortlink" href="Better+hashing.html">
    <meta name="wikilink" content="[design:Better hashing]">
    <meta name="page-version" content="72">

</head>

<body             onload="placeFocus()"
     id="com-atlassian-confluence" class="theme-documentation ">
<div id="full-height-container">
    <div id="header-precursor">
        
        
                </div>

<div id="header" class="sectionbottom ">
        <form id="quick-search" class="quick-search" method="get" action="../../dosearchsite.action.html">
                <fieldset>
            <input type="hidden" name="spaceSearch" value="false"/>
        </fieldset>
        <fieldset>
            <legend>Quick Search</legend>
            <input class="quick-search-query" id="quick-search-query" type="text" accessKey="search-pages-action.accesskey" autocomplete="off" name="queryString" size="25"/>
            <input class="quick-search-submit" id="quick-search-submit" type="submit"  value="Search Confluence" />
            <div class="aui-dd-parent quick-nav-drop-down"><!-- Quick nav appears here --></div>
        </fieldset>
        <fieldset class="hidden parameters">
            <input type="hidden" id="quickNavEnabled" value="true" />
                    </fieldset>
    </form>

    <ul id="header-menu-bar" class="ajs-menu-bar">
                    
        
            <li class="normal ajs-menu-item">
        <a id="browse-menu-link" class="browse trigger ajs-menu-title" href="#"><span><span>Browse</span></span></a>         <div class="assistive ajs-drop-down">
                        <ul  id="browse-menu-link-leading"                 class="section-leading first">
                                        <li>
    
        
    
    <a  id="space-pages-link" href="../../pages/recentlyupdated.action-key=design.html"  class=""   title="Browse pages in the Clojure Design space">
                   <span>Pages</span></a>        </li>
                                        <li>
    
        
    
    <a  id="space-blogposts-link" href="../../pages/viewrecentblogposts.action-key=design.html"  class=""   title="Browse blogs in the Clojure Design space">
                   <span>Blog</span></a>        </li>
                                        <li>
    
        
    
    <a  id="space-labels-link" href="../../labels/listlabels-heatmap.action-key=design.html"  class=""   title="Browse labels in the Clojure Design space">
                   <span>Labels</span></a>        </li>
                                        <li>
    
        
    
    <a  id="space-attachments-link" href="../../spaces/listattachmentsforspace.action-key=design.html"  class=""   title="Browse attachments in the Clojure Design space">
                   <span>Attachments</span></a>        </li>
                                        <li>
    
        
    
    <a  id="space-mail-link" href="../../spaces/viewmailarchive.action-key=design.html"  class=""   title="Browse mail in the Clojure Design space">
                   <span>Mail</span></a>        </li>
                                        <li>
    
        
    
    <a  id="space-advanced-link" href="../../spaces/viewspacesummary.action-key=design.html"  class=""   title="Browse additional space functions in the Clojure Design space">
                   <span>Advanced</span></a>        </li>
                            </ul>
                        <ul  id="browse-menu-link-global"                 class="section-global">
                                        <li>
    
        
    
    <a  id="whats-new-menu-link" href="http://docs.atlassian.com/confluence/docs-40/whatsnew/iframe"  class=""   title="">
                   <span>What’s New</span></a>        </li>
                                        <li>
    
        
    
    <a  id="space-directory-link" href="../../spacedirectory/view.action.html"  class=""   title="Browse the Confluence space directory">
                   <span>Space Directory</span></a>        </li>
                                        <li>
    
        
    
    <a  id="feed-builder-link" href="../../dashboard/configurerssfeed.action.html"  class=""   title="Create your custom RSS feed.">
                   <span>Feed Builder</span></a>        </li>
                                        <li>
    
            
    
    <a  id="keyboard-shortcuts-link" href="#"  class=""   title="View available keyboard shortcuts">
                   <span>Keyboard Shortcuts</span></a>        </li>
                                        <li>
    
            
    
    <a  id="gadget-directory-link" href="#"  class="user-item administration-link"   title="Browse gadgets provided by Confluence">
                   <span>Confluence Gadgets</span></a>        </li>
                            </ul>
                    </div>
    </li>
        
                                                         <li class="ajs-menu-item normal">
        
        
    
    <a  id="login-link" href="../../login.action-os_destination=-display-design-Better+hashing.html"  class="user-item login-link"   title="">
                   <span>Log In</span></a>        </li>
                            <li class="ajs-menu-item normal">
    
        
    
    <a  id="signup-link" href="../../signup.action.html"  class="user-item signup-link"   title="">
                   <span>Sign Up</span></a>        </li>
                                <li class="normal ajs-menu-item">
            <div id="splitter-button" class="hidden" title="Show or hide sidebar"></div>
        </li>

    </ul>
    
    
    <ol id="breadcrumbs">
                    
                        
        <li class="first" >
                                    <span><a href="../../dashboard.action.html" title="Go to Dashboard">Dashboard</a></span>
                </li>
                    
                
        <li>
                                    <span><a href="Home-jsessionid=3A56E29DA520B75101350BA4484B9990.html">Clojure Design</a></span>
                </li>
                                        <li id="ellipsis" title="Show all breadcrumbs"><span><strong>&#8230;</strong></span></li>
                                    
                
        <li class="hidden-crumb" >
                                    <span><a href="Home.html">Home</a></span>
                </li>
                                
                
        <li class="hidden-crumb" >
                                    <span><a href="Release+Planning.html">Release Planning</a></span>
                </li>
                                
                
        <li class="hidden-crumb" >
                                    <span><a href="Release+1.6.html">Release 1.6</a></span>
                </li>
                    
                
        <li>
                                    <span><a href="Better+hashing.html">Better hashing</a></span>
                </li>
        </ol>

</div>

    <div id="splitter">
    <div id="splitter-sidebar" >
        

                    
        
    

<div class="plugin_pagetree">

                <div id="pagetreesearch">
            <form method="POST" action="../../dosearchsite.action-searchQuery.queryString=&amp;searchQuery.spaceKey=conf_all.html" name="pagetreesearchform">
                                    <input type="hidden" name="ancestorId" value="458775">
                                <input type="hidden" name="spaceKey" value="design">
                <input type="text"  size="20" name="queryString">
                <input type="submit" value="Search">
            </form>
        </div>
    
        
    <ul class="plugin_pagetree_children_list plugin_pagetree_children_list_noleftspace">
        <div class="plugin_pagetree_children">
        </div>
    </ul>

    <fieldset class="hidden">
        <input type="hidden" name="treeId" value="">
        <input type="hidden" name="treeRequestId" value="/plugins/pagetree/naturalchildren.action?decorator=none&amp;excerpt=false&amp;sort=position&amp;reverse=false&amp;disableLinks=false">
        <input type="hidden" name="treePageId" value="8192765">

        <input type="hidden" name="noRoot" value="false">
        <input type="hidden" name="rootPageId" value="458775">

        <input type="hidden" name="rootPage" value="">
        <input type="hidden" name="startDepth" value="0">
        <input type="hidden" name="spaceKey" value="design" >

        <input type="hidden" name="i18n-pagetree.loading" value="Loading...">
        <input type="hidden" name="i18n-pagetree.error.permission" value="Unable to load page tree. It seems that you do not have permission to view the root page.">
        <input type="hidden" name="i18n-pagetree.eeror.general" value="There was a problem retrieving the page tree. Please check the server log file for more information.">
        <input type="hidden" name="loginUrl" value="/login.action?os_destination=%2Fdisplay%2Fdesign%2FBetter%2Bhashing">

                <fieldset class="hidden">
                                                <input type="hidden" name="ancestorId" value="9142387">
                                    <input type="hidden" name="ancestorId" value="5767475">
                                    <input type="hidden" name="ancestorId" value="458775">
                                    </fieldset>
    </fieldset>
</div>



            </div>
    <div id="splitter-content">

                    <script type="text/javascript" src="../../s/en_GB/3047/3/2.0.5/_/download/resources/com.atlassian.confluence.plugins.doctheme-resources/doc-theme.js"></script>
    
            
    
<div id="main" >
    <div id="main-header">
	    
	    
    <div id="navigation" class="content-navigation view">
                    <ul class="ajs-menu-bar">
                                
                        
            <li class="normal ajs-menu-item">
        <a id="action-menu-link" class="action trigger ajs-menu-title" href="#"><span><span>Tools</span></span></a>         <div class="assistive ajs-drop-down">
                        <ul  id="action-menu-link-primary"                 class="section-primary first">
                                        <li>
    
        
    
    <a  id="view-attachments-link" href="../../pages/viewpageattachments.action-pageId=8192765.html"  class="action-view-attachments"  accessKey="a"  title="View Attachments">
                   <span><u>A</u>ttachments (2)</span></a>        </li>
                                        <li>
    
        
    
    <a  id="action-view-history-link" href="../../pages/viewpreviousversions.action-pageId=8192765.html"  class="action-view-history"   title="">
                   <span>Page History</span></a>        </li>
                                        <li>
    
        
    
    <a  id="action-page-permissions-link" href="../../pages/viewinfo.action-pageId=8192765.html"  class="action-page-permissions"   title="Edit restrictions">
                   <span>Restrictions</span></a>        </li>
                            </ul>
                        <ul  id="action-menu-link-secondary"                 class="section-secondary">
                                        <li>
    
        
    
    <a  id="view-page-info-link" href="../../pages/viewinfo.action-pageId=8192765.html"  class="action-view-info"   title="">
                   <span>Info</span></a>        </li>
                                        <li>
    
        
    
    <a  id="link-to-page-link" href="../../pages/viewinfo.action-pageId=8192765.html"  class=""   title="Link to this Page">
                   <span>Link to this Page&hellip;</span></a>        </li>
                                        <li>
    
        
    
    <a  id="view-in-hierarchy-link" href="../../pages/listpages-dirview.action-key=design&amp;openId=8192765.html#selectedPageInHierarchy"  class=""   title="">
                   <span>View in Hierarchy</span></a>        </li>
                                        <li>
    
        
    
    <a  id="action-view-source-link" href="../../plugins/viewsource/viewpagesrc.action-pageId=8192765.html"  class="action-view-source popup-link"   title="">
                   <span>View Source</span></a>        </li>
                            </ul>
                    </div>
    </li>
            </ul>
    </div>

	    
	    <h1 id="title-heading" class="pagetitle">
	        	            <a href="Home-jsessionid=3A56E29DA520B75101350BA4484B9990.html"><img class="logo global custom" src="../../download/attachments/131074/global.logo.png" alt=""></a>	        	
			<span id="title-text">
							            <a href="Better+hashing.html">Better hashing</a>
    						</span>
	    </h1>
	</div>

    

    
    
    
    
    

                                                                                                                                                                                                                                                                                                                                                                                                                                                                      




        













    
    
        
    
    
                    
    

    


<div id="content" class="page view">
    



                
<script type="text/x-template" title="movePageDialog">
    <div class="row information">
        <div class="inner">
            <div class="element">
                Specify the new parent page for this page and its children by space and title.
            </div>
        </div>
    </div>
    <div class="form">
        <fieldset>
                

    <legend class="assistive"><span>Change the Parent Page to a Known Page</span></legend>
            <div class="row">
                <label for="new-space">New space:</label>
                <div class="value new-space-value">
                    <input id="new-space-key" name="new-space-key" type="hidden" value="design">
                                            <span class="space-input">
                            <input id="new-space" name="new-space" value="Clojure Design" disabled="disabled">
                        </span>
                        <span class="description warning">You cannot move this page to another space because you do not have permission to remove it from this space.</span>
                                        <div class="new-space-dropdown aui-dd-parent autocomplete"></div>
                </div>
            </div>
            <div class="row">
                <label for="new-parent-page">New parent page:</label>
                <div class="value new-parent-page-value">
                    <span class="page-input">
                        <input id="new-parent-page" name="new-parent-page" value="Release 1.6">
                    </span>
                    <span class="description">Start typing a page title to see a list of suggestions.</span>
                    <div class="new-parent-page-dropdown aui-dd-parent autocomplete"></div>
                </div>
            </div>
        </fieldset>
    </div>
    <div class="location-info">
        <div class="row">
            <label>Current location:</label>
            <div class="value breadcrumbs-container">
                <div class="breadcrumbs-line">
                    <ul id="current-parent-breadcrumbs" class="breadcrumbs">
                    </ul>
                </div>
            </div>
        </div>
        <div class="row">
            <label>New location:</label>
            <div class="value breadcrumbs-container">
                <div class="breadcrumbs-line">
                    <ul id="new-parent-breadcrumbs" class="breadcrumbs">
                    </ul>
                </div>
            </div>
        </div>
    </div>
</script>

<script type="text/x-template" title="movePageSearchPanel">
    <div class="row information">
        <div class="inner">
            <div class="element">
                Search for and select the new parent page for this page and its children.
            </div>
        </div>
    </div>
    <div id="move-page-search-container" class="row">
        <div class="search-form">
            <fieldset>
                    

    <legend class="assistive"><span>Search for a New Parent Page</span></legend>
                    

    <label  for="move-page-search-query" class="assistive">Search keywords</label>
                <input class="search-query" id="move-page-search-query">
                    

    <label  for="move-page-search-space" class="assistive">Search in space</label>
                                    <select id="move-page-search-space" class="search-space" disabled="disabled">
                        <option value="design" selected="selected">Clojure Design</option>
                    </select>
                                <input type="button" value="Search">
                                    <div class="description warning">You cannot move this page to another space because you do not have permission to remove it from this space.</div>
                            </fieldset>
        </div>
        <div class="search-results">
        </div>
    </div>
</script>
<script type="text/x-template" title="searchResultsGrid">
    <table>
        <thead>
            <tr class="header">
                <th class="search-result-title">Page Title</th>
                <th class="search-result-space">Space</th>
                <th class="search-result-date">Updated</th>
            </tr>
        </thead>
    </table>
</script>
<script type="text/x-template" title="searchResultsGridCount">
    <p class="search-result-count">{0}</p>
</script>
<script type="text/x-template" title="searchResultsGridRow">
    <tr class="search-result">
        <th class="search-result-title"><a href="{1}" class="content-type-{2}"><span>{0}</span></a></th>
        <td class="search-result-space"><a class="space" href="/display/{4}/" title="{3}">{3}</a></td>
        <td class="search-result-date"><span class="date" title="{6}">{5}</span></td>
    </tr>
</script><!-- Start restrictions section -->
<script type="text/x-template" title="page-permissions-div">
<div id="page-permissions-div">
    <div id="page-permissions-editor-form">

                <div id="page-permissions-error-div" class="hidden">
            <a href="#" id="permissions-error-div-close">Ok</a>
            <div></div>
        </div>

                <div id="page-permissions-type-radios" class="page-permissions-label-rows">
            <div>
                <input id="restrictViewRadio" type="radio" checked="checked" name="pagePermissionTypeRadio" value="view"/>
                <label for="restrictViewRadio">Restrict viewing of this page</label>
                <input id="restrictEditRadio" type="radio" name="pagePermissionTypeRadio" value="edit"/>
                <label for="restrictEditRadio">Restrict editing of this page</label>
            </div>
        </div>
        <div id="page-permissions-input" class="page-permissions-label-rows">
            <div class="page-permissions-label">To:</div>
            <div id="page-permissions-chooser-box">
                                <span id="page-permissions-choose-user" class="ajs-button">
                    



    



<a href="#" id='userpicker-popup-link-image' onClick="var picker = window.open('/spaces/openuserpicker.action?key=design&amp;startIndex=0&amp;onPopupSubmit=AJS.PagePermissions.addUserPermissions', 'EntitiesPicker', 'status=yes,resizable=yes,top=100,left=200,width=700,height=680,scrollbars=yes'); picker.focus(); return false;"><img src="/s/en_GB/3047/3/_/images/icons/user_16.gif" height=16 width=16 border=0 align="absmiddle"  title="Choose users" /></a>
<a href="#" id='userpicker-popup-link-text' onClick="var picker = window.open('/spaces/openuserpicker.action?key=design&amp;startIndex=0&amp;onPopupSubmit=AJS.PagePermissions.addUserPermissions', 'EntitiesPicker', 'status=yes,resizable=yes,top=100,left=200,width=700,height=680,scrollbars=yes'); picker.focus(); return false;">Person...</a>


                </span>
                <span id="page-permissions-choose-group" class="ajs-button">
                    



    

 

<a href="#" id='grouppicker-popup-link-image' onClick="var picker = window.open('/spaces/opengrouppicker.action?key=design&amp;startIndex=0&amp;actionName=dosearchgroups.action&amp;onPopupSubmit=AJS.PagePermissions.addGroupPermissions', 'EntitiesPicker', 'status=yes,resizable=yes,top=100,left=200,width=580,height=550,scrollbars=yes'); picker.focus(); return false;"><img src="/s/en_GB/3047/3/_/images/icons/group_16.gif" height=16 width=16 border=0 align="absmiddle"  title="Choose groups" /></a>
<a href="#" id='grouppicker-popup-link-text' onClick="var picker = window.open('/spaces/opengrouppicker.action?key=design&amp;startIndex=0&amp;actionName=dosearchgroups.action&amp;onPopupSubmit=AJS.PagePermissions.addGroupPermissions', 'EntitiesPicker', 'status=yes,resizable=yes,top=100,left=200,width=580,height=550,scrollbars=yes'); picker.focus(); return false;">Group...</a>


                </span>
            </div>
            <div id="page-permissions-input-box">
                <input type="text" id="page-permissions-names-input" name="permissionNames"
                    placeholder="Enter user or group name" class="autocomplete-user"
                    data-max="10" data-none-message="No matches"
                    data-target="#page-permissions-names-hidden" data-template="{username}"
                    data-dropdown-target="#page-perms-name-dropdown-wrapper" data-resize-to-input="true"
                    size="30"/>
                <input
    type="hidden"
                            id="page-permissions-names-hidden"           />                <img height="16px" width="1px" src="/s/en_GB/3047/3/_/images/border/spacer.gif"/>
                <input type="button" id="add-typed-names" value="Restrict">
                <div id="page-perms-name-dropdown-wrapper" class="aui-dd-parent autocomplete"></div>
            </div>
        </div>
    </div>
    <div id="page-permissions-tables">
        <div id="page-permissions-table-div">
                        <table id="page-permissions-table" class="page-permissions-table">
                <tr id="page-permissions-no-views" class="marker-row">
                    <td colspan="3" class="page-permissions-marker-cell"><span>No view restrictions are defined for this page</span></td>
                </tr>
                <tr id="page-permissions-no-edits" class="marker-row">
                    <td colspan="3" class="page-permissions-marker-cell"><span>No edit restrictions are defined for this page</span></td>
                </tr>
            </table>
        </div>
        <div id="page-inherited-permissions-table-div" class="hidden">
            <span id="page-inherited-permissions-table-desc">
                <a class="icon twisty-closed">Show/Hide</a>
                <a id="toggle-inherited-permissions" title="Click to see inherited restrictions">This page has restricted parent pages. It can only be seen by users who can see those parent pages.</a>
            </span>
            <div id="page-inherited-permissions-tables" class="hidden page-inheritance-togglable"></div>
        </div>
    </div>
</div>
</script>

<!-- End restrictions section -->

        
    
    
        <fieldset class="hidden parameters">
            <input type="hidden" title="parentPageId" value="9142387">
        </fieldset>

        
                            
    

                    

        
        <a href="#page-metadata-end" class="assistive">Skip to end of metadata</a>
<div id="page-metadata-start" class="assistive"></div>

    <div class="page-metadata">
        <ul>
                            <li class="page-metadata-item noprint">
    
            
    
    <a  id="content-metadata-page-restrictions" href="#"  class="page-metadata-icon page-restrictions hidden"   title="Page restrictions apply. Click the lock icon to view or edit the restriction.">
                   <span>Page restrictions apply</span></a>        </li>
                            <li class="page-metadata-item noprint">
    
        
    
    <a  id="content-metadata-attachments" href="../../pages/viewpageattachments.action-pageId=8192765&amp;metadataLink=true.html"  class="page-metadata-icon action-view-attachments"  accessKey="a"  title="Attachments: 2">
                   <span><span class="page-metadata-attachments-text">Attachments:</span><span class="page-metadata-attachments-count">2</span></span></a>        </li>
                        <li class="page-metadata-modification-info">
                                    Added by <a href="../../login.action-os_destination=-display-~jafingerhut.html"
                          class="url fn"
                   >Andy Fingerhut</a>, last edited by <a href="../../login.action-os_destination=-display-~jafingerhut.html"
                          class="url fn"
                   >Andy Fingerhut</a> on Apr 06, 2014
                                                                <span class="noprint">&nbsp;(<a id="view-change-link" href="../../pages/diffpages.action-pageId=8192765&amp;originalId=9142402.html">view change</a>)</span>
                                                </li>
                    </ul>
                </div>


<a href="#page-metadata-start" class="assistive">Go to start of metadata</a>
<div id="page-metadata-end" class="assistive"></div>
        
        <fieldset class="hidden parameters">
                        <input type="hidden" title="browsePageTreeMode" value="view">
        </fieldset>

        <div class="wiki-content">
                           <h3 id="Betterhashing-Problem">Problem</h3><p><span style="color: rgb(0,0,0);text-decoration: none;">Clojure’s hashing strategy for numbers, sequences/vectors, sets, and maps mimics Java’s.  In Clojure, however, it is far more common than in Java to use longs, vectors, sets, maps and compound objects comprised of those components (e.g., a map from vectors of longs to sets) as keys in other hash maps.  It appears that Java’s hash strategy is not well-tuned for this kind of usage.  Clojure’s hashing for longs, vectors, sets, and maps each suffer from some weaknesses that can multiply together to create a crippling number of collisions.</span></p><p><span style="color: rgb(0,0,0);text-decoration: none;">For example, Paul Butcher wrote a simple Clojure program that produces a set of solutions to a chess problem.  Each solution in the set was itself a set of vectors of the form [piece-keyword [row-int col-int]].  Clojure 1.5.1's current hash function hashed about 20 million different solutions to about 20 thousand different hash values, for an average of about 1000 solutions per unique hash value.  This causes PersistentHashSet and PersistentHashMap to use long linear searches for testing set/map membership or adding new elements/keys.  There is nothing intentionally pathological about these values – they simply happened to expose this behavior in a dramatic way.  Others have come across similarly bad performance without any obvious reason why, but some of those cases are likely due to this same root cause.<br /></span></p><h3 id="Betterhashing-Proposedsolutions"><span style="color: rgb(0,0,0);text-decoration: none;">Proposed solutions<br /></span></h3><p>Mark Engelberg's document about Clojure's hash function, its behavior, and potential improvements, is here:</p><p>    <a href="https://docs.google.com/document/d/10olJzjNHXn1Si1LsSvjNqF_X1O7OTPZLuv3Uo_duY5o" class="external-link" rel="nofollow">https://docs.google.com/document/d/10olJzjNHXn1Si1LsSvjNqF_X1O7TPZLuv3Uo_duY5o</a></p><p>A summary of his proposed hash function modifications is:</p><ul><li>Change the hash of integers that fit within a long to the return value of longHashMunge (see Longs section of doc for more details)</li><li>Change the current multiplier of 31 used for vectors, sequences, and queues to a different constant such as <span style="color: rgb(0,0,0);text-decoration: none;">-1640531535</span> or <span style="color: rgb(0,0,0);text-decoration: none;">524287</span> (see Vectors section).  Also applies to Cons, LazySeq.</li><li>For sets, instead of adding together the hash value of the elements, add together the return value of a function xorShift32 called on the hash value of each element (see Sets section)</li><li>For maps and records, instead of adding together hash(key) ^ hash(val) for each hash,val pair, instead add together hash(key)^xorShift32(hash(val)) (see Maps section)</li><li>No change for any other types, e.g. strings, keywords, symbols, floats, doubles, BigInt's outside of long range, BigDecimal, etc.</li></ul><p>Below is a link to a modified version of Paul Butcher's N-queens solver, with extra code for printing stats with several different hash functions.  The README has instructions for retrieving and installing locally a version of Clojure modified with one of Mark's proposed alternate hash functions.  After that is a link to a patch that implements the proposal above.</p><p>    <a href="https://github.com/jafingerhut/chess-clojure" class="external-link" rel="nofollow">https://github.com/jafingerhut/chess-clojure</a></p><p>    <a href="../../download/attachments/8192765/better-hashing-2013-11-18.diff" class="external-link" rel="nofollow">http://dev.clojure.org/download/attachments/8192765/better-hashing-2013-11-18.diff</a></p><p>Here is a summary of results for some program elapsed times and how spread out the hash values are.  Below the table are a few details on how these measurements were made.  All times are elapsed times.  &quot;meas&quot; means raw measurements of elapsed time, listed in ascending order so you can easily see min and max.  &quot;avg&quot; is the average of multiple elapsed times.</p><div class="table-wrap"><table class="confluenceTable"><tbody><tr><th class="confluenceTh">Problem</th><th class="confluenceTh"><p>Using Clojure 1.6.0-alpha3 hash (same as Clojure 1.5.1)</p></th><th colspan="1" class="confluenceTh"><p>Clojure 1.6.0 just after <a href="https://github.com/clojure/clojure/commit/96e72517615cd2ccdb4fdbbeb6ffba5ad99dbdac" class="external-link" rel="nofollow">this commit</a> on Jan 29 2014</p></th><th colspan="1" class="confluenceTh">Clojure 1.6.0 just after <a href="https://github.com/clojure/clojure/commit/17b18350bdd28154241bc7ae80f423a5976c6de2" class="external-link" rel="nofollow">this commit</a> on Jan 30 2014</th><th class="confluenceTh">Using Mark Engelberg's 2013-11-18 proposed hash</th><th colspan="1" class="confluenceTh">Using Murmur3 hash</th></tr><tr><td class="confluenceTd"><p>Paul Butcher's N-queens problem with 6x6 board</p><p>180,568 solutions hash to N distinct hash values</p><p>average of A solutions per hash value (max M)</p></td><td class="confluenceTd"><p>6.7 min (~33 times slower than with 2013-11-18 proposed hash)</p><p>N=301</p><p>A=599.9 (M=2,492)</p></td><td colspan="1" class="confluenceTd"><p>12.8 sec</p><p>N=180,566</p><p>A=1.0 (M=2)</p></td><td colspan="1" class="confluenceTd"><p>12.5 sec</p><p>N=180,561</p><p>A=1.0 (M=2)</p></td><td class="confluenceTd"><p>12.2 sec</p><p>N=180,566</p><p>A=1.0 (M=2)</p></td><td colspan="1" class="confluenceTd"><p>11.8 sec</p><p>N=180,567</p><p>A=1.0 (M=2)</p></td></tr><tr><td class="confluenceTd"><p>with 6x9 board</p><p>20,136,752 solutions hash to N distinct hash values</p><p>average of A solutions per hash value (max M)</p></td><td class="confluenceTd"><p>&gt; 8 hours (did not wait for it to finish)</p><p>N=17,936</p><p>A=1,122.7 (M=81,610)</p></td><td colspan="1" class="confluenceTd"><p>12.8 min</p><p>N=20,089,842</p><p>A=1.0 (M=3)</p></td><td colspan="1" class="confluenceTd"><p>11.9 min</p><p>N=20,089,436</p><p>A=1.0 (M=3)</p></td><td class="confluenceTd"><p>11.4 min</p><p>N=20,089,766</p><p>A=1.0 (M=4)</p></td><td colspan="1" class="confluenceTd"><p>12.0 min</p><p>N=20,089,390</p><p>A=1.00 (M=3)</p></td></tr><tr><td colspan="1" class="confluenceTd"><p>Hash all ints in range -1,000,000 to 1,000,000 inclusive</p><p>2,000,001 values hash to N distinct hash values</p><p>average of A integers per hash value (max M)</p></td><td colspan="1" class="confluenceTd"><p>N=1,000,001</p><p>A=2.0 (M=2)</p></td><td colspan="1" class="confluenceTd"><p>N=1,999,801</p><p>A=1.0 (M=2)</p></td><td colspan="1" class="confluenceTd"><p>N=1,999,801</p><p>A=1.0 (M=2)</p></td><td colspan="1" class="confluenceTd"> </td><td colspan="1" class="confluenceTd"> </td></tr><tr><td colspan="1" class="confluenceTd"><p>Hash all 2-element vectors with first element in range [0,999] and second element in same range</p><p>1,000,000 values hash to N distinct hash values</p><p>average of A values per hash value (max M)</p></td><td colspan="1" class="confluenceTd"><p>N=31,969</p><p>A=31.3 (M=33)</p></td><td colspan="1" class="confluenceTd"><p>N=999,846</p><p>A=1.0 (M=2)</p></td><td colspan="1" class="confluenceTd"><p>N=999,900</p><p>A=1.0 (M=2)</p></td><td colspan="1" class="confluenceTd"> </td><td colspan="1" class="confluenceTd"> </td></tr><tr><td colspan="1" class="confluenceTd"><p>Hash all 2-element vectors with first element in range [-500,499] and second element in same range</p><p>1,000,000 values hash to N distinct hash values</p>average of A values per hash value (max M)</td><td colspan="1" class="confluenceTd"><p>N=15,969</p><p>A=62.6 (M=68)</p></td><td colspan="1" class="confluenceTd"><p>N=999,860</p><p>A=1.0 (M=2)</p></td><td colspan="1" class="confluenceTd"><p>N=999,883</p><p>A=1.0 (M=2)</p></td><td colspan="1" class="confluenceTd"> </td><td colspan="1" class="confluenceTd"> </td></tr><tr><td colspan="1" class="confluenceTd"><p>All sets that are subsets of #{0 1 2 3 ... 19}</p><p>1,048,576 sets hash to N distinct hash values</p><p>average of A values per set (max M)</p></td><td colspan="1" class="confluenceTd"><p>N=191</p><p>A=5,489.9 (M=16,440)</p></td><td colspan="1" class="confluenceTd"><p>N=1,048,451</p><p>A=1.0 (M=2)</p></td><td colspan="1" class="confluenceTd"><p>N=1,048,208</p><p>A=1.0 (M=2)</p></td><td colspan="1" class="confluenceTd"> </td><td colspan="1" class="confluenceTd"> </td></tr><tr><td colspan="1" class="confluenceTd"><p>All maps {i j} where i is in the range [0,999] and j is in the same range</p><p>1,000,000 maps hash to N distinct hash values</p><p>average of A values per map (max M)</p></td><td colspan="1" class="confluenceTd"><p>N=1,024</p><p>A=976.6 (M=1,000)</p></td><td colspan="1" class="confluenceTd"><p>N=999,728</p><p>A=1.0 (M=2)</p></td><td colspan="1" class="confluenceTd"><p>N=999,900</p><p>A=1.0 (M=2)</p></td><td colspan="1" class="confluenceTd"> </td><td colspan="1" class="confluenceTd"> </td></tr><tr><td colspan="1" class="confluenceTd"><p>Compile Clojure 1.6.0-alpha3 source with &quot;time ant jar&quot;, so no tests run</p></td><td colspan="1" class="confluenceTd"><p>avg 20.1 sec</p><p>meas: 19.6, 19.8, 19.8, 20.2, 20.9</p></td><td colspan="1" class="confluenceTd"><p>avg 20.6 sec (2.5% longer)</p><p>meas: 19.8, 20.4, 20.7, 20.8, 21.3</p></td><td colspan="1" class="confluenceTd"><p>avg 20.6 sec (2.5% longer)</p><p>meas: 20.3, 20.5, 20.5, 20.8, 20.9</p></td><td colspan="1" class="confluenceTd"><p>avg 20.0 sec</p><p>meas: 19.6, 19.7, 19.9, 20.2, 20.7</p></td><td colspan="1" class="confluenceTd"><p>avg 21.4 sec (6.5% longer)</p><p>meas: 21.3, 21.4, 21.4, 21.4 21.6</p></td></tr><tr><td colspan="1" class="confluenceTd"><p>Compile Clojure 1.6.0-alpha3 source with &quot;time ant&quot;, which includes running tests, but with generative test duration reduced to 1.0 sec</p></td><td colspan="1" class="confluenceTd"><p>avg 48.0 sec</p><p>meas: 47.3, 47.4, 47.6, 48.3, 49.5</p><p>120,353 unique values hash to 113,405 distinct hash values</p><p>average of 1.06 values per hash value</p></td><td colspan="1" class="confluenceTd"><p>avg 47.7 sec</p><p>meas: 47.2, 47.4, 47.6, 47.9, 48.2</p></td><td colspan="1" class="confluenceTd"><p>avg 47.3 sec</p><p>meas: 46.8, 47.2, 47.4, 47.5, 47.8</p></td><td colspan="1" class="confluenceTd"><p>avg 48.0 sec</p><p>meas: 47.1, 47.6, 47.7, 48.2, 49.5</p><p>119,811 unique values hash to 114,329 distinct hash values</p><p>average of 1.05 values per hash value</p></td><td colspan="1" class="confluenceTd"><p>avg 48.7 sec (1.5% longer)</p><p>meas: 47.8, 48.5, 48.9 49.1 49.3</p></td></tr><tr><td colspan="1" class="confluenceTd"><p>Calc hashes of all integers in (range 1000000000) and return sum, using:</p><p>(time (hash-range-n 1000000000))</p><p>See <a href="https://github.com/jafingerhut/chess-clojure/blob/master/src/chess_clojure/core.clj#L425" class="external-link" rel="nofollow">here</a> for definition of hash-range-n</p></td><td colspan="1" class="confluenceTd"><p>avg 29.8 sec</p><p>meas: 29.6, 29.6, 29.9, 30.0, 30.1</p></td><td colspan="1" class="confluenceTd"><p>avg 47.9 sec (60.7% longer)</p><p>meas: 47.9, 47.9, 47.9, 47.9, 48.0</p></td><td colspan="1" class="confluenceTd"><p>avg 44.3 sec (48.7% longer)</p><p>meas: 43.2, 43.3, 45.0, 45.0, 45.0</p></td><td colspan="1" class="confluenceTd"><p>avg 38.7 sec (30% longer)</p><p>meas: 38.6, 38.6, 38.7, 38.7, 38.7</p><p>Verified that hash values of first 500 million integers (those in (range 500000000)) are all different.</p></td><td colspan="1" class="confluenceTd"><p>avg 30.2 sec (1.3% longer)</p><p>meas: 29.9, 30.2, 30.2, 30.2, 30.2</p></td></tr><tr><td colspan="1" class="confluenceTd"><p>Calc hashes of 30,001 vectors [] [0] [0 1], etc. up to [0 1 ... 29999] and return sum, using</p><p>(let [cs (doall (reductions conj [] (range 30000)))]</p><p>  (time (total-hash cs)))</p><p>See <a href="https://github.com/jafingerhut/chess-clojure/blob/master/src/chess_clojure/core.clj#L433" class="external-link" rel="nofollow">here</a> for definition of total-hash</p></td><td colspan="1" class="confluenceTd"><p>avg 10.7 sec</p><p>meas: 10.6, 10.6, 10.7, 10.7, 10.7</p><p>30,000 unique hash values, avg 1.00, max 2</p></td><td colspan="1" class="confluenceTd"><p>avg 16.0 sec (49.5% longer)</p><p>meas: 15.9, 16.0, 16.1, 16.1, 16.1</p><p>All 30,001 hash values unique</p></td><td colspan="1" class="confluenceTd"><p>avg 14.3 sec (33.6% longer)</p><p>meas: 14.1, 14.3, 14.3, 14.3, 14.3</p><p>All 30,001 hash values unique</p></td><td colspan="1" class="confluenceTd"><p>avg 10.8 sec (pretty much same)</p><p>meas: 10.5, 10.7, 10.7, 10.7, 11.6</p><p>30,000 unique hash values, avg 1.00, max 2</p></td><td colspan="1" class="confluenceTd"><p>avg 11.4 sec (6.5% longer)</p><p>meas: 11.3, 11.3, 11.4, 11.4, 11.4</p><p>All 30,001 hash values unique</p></td></tr><tr><td colspan="1" class="confluenceTd"><p>Calc hashes of 30,001 sets #{} #{0} #{0 1}, etc. up to #{0 1 ... 29999} and return sum, using</p><p>(let [cs (doall (reductions conj #{} (range 30000)))]</p><p>  (time (total-hash cs)))</p></td><td colspan="1" class="confluenceTd"><p>avg 70.2 sec</p><p>meas: 66.4, 69.1, 69.4, 71.3, 74.8</p><p>30,000 unique hash values, avg 1.00, max 2</p></td><td colspan="1" class="confluenceTd"><p>avg 86.3 sec (22.9% longer)</p><p>meas: 83.3, 84.1, 86.3, 88.2, 89.5</p><p>All 30,001 hash values unique</p></td><td colspan="1" class="confluenceTd"><p>avg 81.8 sec (16.5% longer)</p><p>meas: 78.8, 79.1, 80.1, 81.2, 89.6</p><p>All 30,001 hash values unique</p></td><td colspan="1" class="confluenceTd"><p>avg 71.4 sec (1.7% longer)</p><p>meas: 70.9, 71.0, 71.2, 72.0, 72.1</p><p>29,308 unique hash values, avg 1.02, max 2</p></td><td colspan="1" class="confluenceTd"><p>avg 71.6 sec (2.0% longer)</p><p>meas: 67.9, 72.0, 72.5, 72.7, 73.1</p><p>All 30,001 hash values unique</p></td></tr><tr><td colspan="1" class="confluenceTd"><p>Calc hashes of 30,001 maps {} {0 1} {0 1, 1 2} ... up to {0 1, 1 2, ..., 29999 30000} and return sum, using</p><p>(let [cs (doall (reductions (fn [m i] (assoc m i (inc i))) {} (range 30000)))]</p><p> (time (total-hash cs)))</p></td><td colspan="1" class="confluenceTd"><p>avg 71.7 sec</p><p>meas: 68.4, 69.0, 69.1, 75.7, 76.3</p><p>All 30,001 hash values unique</p></td><td colspan="1" class="confluenceTd"><p>avg 163.4 (127.9% longer)</p><p>meas: 159.2, 159.2, 164.3, 166.5, 167.5</p><p>All 30,001 hash values unique</p></td><td colspan="1" class="confluenceTd"><p>avg 124.6 sec (73.8% longer)</p><p>meas: 115.7, 125.5, 126.6, 127.4, 127.8</p><p>All 30,001 hash values unique</p></td><td colspan="1" class="confluenceTd"><p>avg 78.5 sec (9.5% longer)</p><p>meas: 74.1, 75.0, 77.0, 81.2, 85.4</p><p>All 30,001 hash values unique</p></td><td colspan="1" class="confluenceTd"><p>avg 89.3 sec (24.5% longer)</p><p>meas: 83.9, 87.8, 89.8, 91.2, 93.7</p><p>All 30,001 hash values unique</p></td></tr></tbody></table></div><p>Notes on measurements:</p><p>Only the N-queens measurements used Leiningen.  The compilation measurements used the ant commands shown.  The rest were measured using the expressions shown after starting a JVM with the command line:</p><pre>    java -cp clojure.jar clojure.main</pre><p>with the version of clojure.jar given in the column heading.  5 measurements were taken for each.  The raw measurements are given, and the average.  Each individual run is intended to be long enough to avoid any concerns about misleading measurements from microbenchmarks.</p><p>Benchmark versions: hardware is MacPro 2,1 with 2 3GHz quad-core Intel Xeons, 32 GB RAM.  OS is Mac OS X 10.6.8.  JVM is Apple/Oracle-supplied version 1.6.0_65, 64-bit Server VM.</p><h3 id="Betterhashing-Openquestions">Open questions</h3><p>Possible small changes to the proposal for consideration:</p><ul><li>Add in some magic constant to the hash of all sets and maps (a different constant for sets than for maps), so that the empty set and empty map have non-0 hash values, and thus nested data structures like #{{}} and {#{} #{}} will hash to non-0 values that are different from each other.</li><li>Consider doing something besides the current hash(numerator) ^ hash(denominator) for Ratio values.  Perhaps hash(numerator) + xorShift32(hash(denominator)) ?  That would avoid the hash of 3/7 and 7/3 being the same, and also avoid the current behavior that hash(3/7) &quot;undoes&quot; the longHashMunge proposed for both the numerator and denominator long values.</li></ul><h3 id="Betterhashing-Tradeoffsandalternatives">Tradeoffs and alternatives</h3><p>These are discussed throughout Mark's document.  A few of these are called out below</p><ul><li>Nearly all of the proposals involve additional operations on ints or longs.  This is expected to require little additional elapsed time in most hash computations, given that the most significant cost in hashing collections is usually traversing the parts of the data structure, especially if that involves cache misses.  Measurements are given above for one proposed set of hash function changes.</li><li>Murmur3 is widely used, but does not lend itself well to incremental updates of hash calculations of collections.</li></ul><h3 id="Betterhashing-Afollow-upwriteup">A follow-up writeup</h3><p>I (Alex Miller) have spent a bunch of time looking at this. It probably bears some discussion before updating this page so I will simply append this new section for now.</p><p><a href="https://docs.google.com/a/thinkrelevance.com/document/d/1DT2uXlAwH5NstgYSeqbOXb_8K6Gwnw99QksCaUKpCjU/edit" class="external-link" rel="nofollow">https://docs.google.com/a/thinkrelevance.com/document/d/1DT2uXlAwH5NstgYSeqbOXb_8K6Gwnw99QksCaUKpCjU/edit</a></p><p>For me, it was a key thing to restate the problem as: &quot;Slightly different collections frequently produce identical hash codes&quot;. The primary use where this is an issue is when using sets that contain collections of similar values, especially numbers.</p><p>A summary of my conclusions:</p><ul><li>DO NOT change long hashing. Not worth the effort or differences from Java.</li><li>DO change the vector hashcode algorithm either by changing the multiplier constant, rehashing the items, or both. (Currently I lean towards only rehashing the items.)</li><li>DO change the set hashcode algorithm to rehash the items before summing.</li><li>DO change the map hashcode algorithm to to remove the symmetric inclusion of keys and values. My preferred change would be to treat K/V as a 2-element vector and re-use whatever algorithm we use for that.</li><li>DO NOT use xorShift32 for rehash - the reliance on xor can easily cause collisions when summing hashcodes in sets.</li><li>DO use Murmur3 as rehash algorithm - it's fast, extremely well-tested, commonly used, has great avalanche and bit dispersion properties. Note, this is not for hashing the entire collection, but for rehashing individual element hash codes.</li><li>DO NOT change the hashCode() of collection functions; change only the hasheq() algorithms.</li><li>CONSIDER rehashing keys in PersistentHashMap.hash() for storage and retrieval - this would yield better hash keys for all users of persistent hash maps and sets, not just for numbers, but also for keywords, strings, symbols, and whatever else you put in them. This could yield shallower trees and better average performance on hash lookup for large trees. Proving this would likely require instrumentation inside PHM and/or developing some more intensive performance studies. </li></ul><h3 id="Betterhashing-References"><span style="font-size: 1.4em;">References </span></h3><p>Some useful references:</p><ul><li><a href="http://www.jstatsoft.org/v08/i14/paper" class="external-link" rel="nofollow">Xorshift RNGs</a> - source for the &quot;munge&quot; algorithm</li><li><span style="color: rgb(0,0,0);">Knuth, section 6.4 - popular multiplier for multiplicative hashing of sequences</span></li><li><a href="http://code.google.com/p/smhasher/wiki/MurmurHash3" class="external-link" rel="nofollow">MurmurHash3</a></li><li><a href="http://programmers.stackexchange.com/questions/49550/which-hashing-algorithm-is-best-for-uniqueness-and-speed" class="external-link" rel="nofollow">Which hashing algorithm is better for uniqueness and speed</a></li><li>Scala's <a href="http://www.scala-lang.org/api/current/index.html#scala.util.hashing.MurmurHash3$" class="external-link" rel="nofollow">MurmurHash3 implementation</a> (used for collection hashing) and <a href="http://stackoverflow.com/questions/14797505/migrate-from-murmurhash-to-murmurhash3" class="external-link" rel="nofollow">more info</a> on how to use it.</li><li>Guava has a good <a href="http://docs.guava-libraries.googlecode.com/git/javadoc/src-html/com/google/common/hash/Hashing.html" class="external-link" rel="nofollow">hashing impl</a> of Murmur3 and other hash functions. And <a href="https://code.google.com/p/guava-libraries/wiki/HashingExplained" class="external-link" rel="nofollow">explanation of hashing</a>.</li><li>Collection of <a href="http://burtleburtle.net/bob/hash/integer.html" class="external-link" rel="nofollow">integer hash functions</a></li><li><a href="https://code.google.com/p/xxhash/" class="external-link" rel="nofollow">xxhash</a> (native code on most platforms) but it also has perf and quality tests for many hashes (I think these were tested in streaming though) </li><li><a href="https://code.google.com/p/fast-hash/" class="external-link" rel="nofollow">fast-hash</a></li><li><a href="https://code.google.com/p/smhasher/" class="external-link" rel="nofollow">SMHasher</a> - hash testing</li><li>Good overview of <a href="http://blog.aggregateknowledge.com/2012/02/02/choosing-a-good-hash-function-part-3/" class="external-link" rel="nofollow">how to compare hashes for quality</a> and list of results</li></ul><h3 id="Betterhashing-TrackingupdatestootherlibrariesforClojure16hashchanges">Tracking updates to other libraries for Clojure 1.6 hash changes</h3><p>Clojure 1.6.0-beta1 is out as of this writing, and the hash method has been decided upon.  Now comes updating Clojure contrib libraries and 3rd party Clojure libraries that implement their own customized collections so that their hash function values for custom sets and maps (at least those intended to be clojure.core/= to built-in Clojure sets, vectors, or maps) have consistent hash values when using Clojure 1.6.</p><p>The table below gives some places that could use updating, and status of changes.</p><p>Notes: In Clojure 1.5.1 and 1.4.0 (and maybe also 1.3.0?), (.hashCode x) and (hash x) were calculated similarly, and had the same value for many values of x, even many sets, maps, and vectors.  However, they were <strong>not</strong> always the same, because (.hashCode x) uses .hashCode to hash each set/vector element or map key-value pair, whereas (hash x) uses hash to do so, and .hashCode and hash are intentionally different for Integers, Shorts, Bytes, and some other types.</p><p>In Clojure 1.6.0, (.hashCode x) should remain consistent with Java .hashCode for all sets, maps, and vectors, whereas (hash x) will almost always be different than (.hashCode x).  Unit tests should include special cases comparing hash of your custom collection against Clojure's corresponding built-in collection for the empty set, vector, and/or map, because that is no longer the simple value of 0/1 that it was before.  Also test the result of (empty my-custom-non-empty-collection), too.  Consider using the <a href="https://github.com/ztellman/collection-check" class="external-link" rel="nofollow">collection-check</a> library.</p><div class="table-wrap"><table class="confluenceTable"><tbody><tr><th class="confluenceTh">Project/Library</th><th class="confluenceTh">What needs updating?</th><th class="confluenceTh">Status</th></tr><tr><td class="confluenceTd">Tests in Clojure itself</td><td class="confluenceTd"><p>Some tests were disabled when the hash changes were first made, with <a href="https://github.com/clojure/clojure/commit/dff9600387b962f16fc78e6477e10e34651fd366" class="external-link" rel="nofollow">this commit</a>.</p></td><td class="confluenceTd"><p>DONE (except one test still disabled): Most of them were updated to be independent of Clojure's hash function with <a href="https://github.com/clojure/clojure/commit/91dd867b4229a31d4d915aece97f41b3811cf4d4" class="external-link" rel="nofollow">this commit</a>, but the following line at or near line 311 in file test/clojure/test_clojure/java_interop.clj is still commented out:</p><p>;;(test-to-passed-array-for hash-set)</p></td></tr><tr><td class="confluenceTd">core.cache</td><td class="confluenceTd">Some tests failed due to hash-dependent sequence orders</td><td class="confluenceTd">DONE: Patch for ticket <a href="../../jira/browse/CCACHE-33.html" class="external-link" rel="nofollow">CCACHE-33</a> committed</td></tr><tr><td class="confluenceTd">core.match</td><td class="confluenceTd">Some tests failed due to hash-dependent sequence orders</td><td class="confluenceTd">DONE: Fix for ticket <a href="../../jira/browse/MATCH-94.html" class="external-link" rel="nofollow">MATCH-94</a> committed</td></tr><tr><td colspan="1" class="confluenceTd"><a href="https://github.com/mikera/core.matrix" class="external-link" rel="nofollow">core.matrix</a></td><td colspan="1" class="confluenceTd">Mike Anderson says it should be ready for Clojure 1.6 with no updates needed.</td><td colspan="1" class="confluenceTd">DONE: No changes needed.</td></tr><tr><td colspan="1" class="confluenceTd">core.rrb-vector</td><td colspan="1" class="confluenceTd">Hash calculation needs updating</td><td colspan="1" class="confluenceTd">DONE: Fix for ticket <a href="../../jira/browse/CRRBV-3.html" class="external-link" rel="nofollow">CRRBV-3</a> committed.</td></tr><tr><td colspan="1" class="confluenceTd">data.avl</td><td colspan="1" class="confluenceTd">Hash calculation needs updating</td><td colspan="1" class="confluenceTd">DONE: Fix for ticket <a href="../../jira/browse/DAVL-3.html" class="external-link" rel="nofollow">DAVL-3</a> committed in <a href="https://github.com/clojure/data.avl/commit/99c895e9e688452c91903d00c06b8f1201df7f8d" class="external-link" rel="nofollow">commit 1</a>, <a href="https://github.com/clojure/data.avl/commit/3f410c21f640c1bdd46575777eca6a8476e1d74b" class="external-link" rel="nofollow">2</a>, and <a href="https://github.com/clojure/data.avl/commit/0e0fa0563693dd7d1bd612032df91e740250f78d" class="external-link" rel="nofollow">3</a>.</td></tr><tr><td colspan="1" class="confluenceTd">data.finger-tree</td><td colspan="1" class="confluenceTd">Hash calculation for finger trees needs updating for 1.6</td><td colspan="1" class="confluenceTd">DONE: Fix for ticket <a href="../../jira/browse/DFINGER-2.html" class="external-link" rel="nofollow">DFINGER-2</a> committed.</td></tr><tr><td colspan="1" class="confluenceTd"><a href="https://github.com/ztellman/immutable-bitset" class="external-link" rel="nofollow">immutable-bitset</a></td><td colspan="1" class="confluenceTd">Hash calculation for bitsets needs updating for 1.6</td><td colspan="1" class="confluenceTd">DONE: Fixed with <a href="https://github.com/ztellman/immutable-bitset/commit/515c8607f6472bdcad3443600761b7229ded1f4d" class="external-link" rel="nofollow">this commit</a>.  Note that this data structure is a special case, in that it can only contain Long values, thus in Clojure 1.5.1 and earlier it was guaranteed that (.hashCode immutable-bitset) and (hash immutable-bitset) were equal for all immutable-bitsets.  This is <strong>not</strong> true in general for other collections, because (.hashCode x) and (hash x) are in general different for Integers, Shorts, Bytes, etc.</td></tr><tr><td colspan="1" class="confluenceTd"><a href="https://github.com/Engelberg/instaparse" class="external-link" rel="nofollow">instaparse</a></td><td colspan="1" class="confluenceTd">Mark Engelberg says this relies on incremental hashing, and will need some rethinking on how to update.</td><td colspan="1" class="confluenceTd">Some changes have been made on branch &quot;1.6&quot; in instaparse's Github repository and tested for correctness and performance.  Progress reports <a href="https://groups.google.com/d/msg/clojure-dev/pQCrYHi6doo/LkJexCyI2_oJ" class="external-link" rel="nofollow">here</a>, <a href="https://groups.google.com/d/msg/clojure-dev/t6LAmVe-RLM/ZsyKbPtr2o0J" class="external-link" rel="nofollow">here</a>.</td></tr><tr><td colspan="1" class="confluenceTd"><a href="https://github.com/flatland/ordered" class="external-link" rel="nofollow">ordered</a></td><td colspan="1" class="confluenceTd">Namespaces flatland.ordered.map and flatland.ordered.set appear to need updates</td><td colspan="1" class="confluenceTd"> </td></tr><tr><td colspan="1" class="confluenceTd"><a href="https://github.com/ztellman/potemkin" class="external-link" rel="nofollow">potemkin</a></td><td colspan="1" class="confluenceTd">A map implementation needs updating</td><td colspan="1" class="confluenceTd">DONE: Fixed with <a href="https://github.com/ztellman/potemkin/commit/d4ea6e98847e987fa2b6a5214ee835d810991c12" class="external-link" rel="nofollow">this commit</a>.</td></tr><tr><td colspan="1" class="confluenceTd">tools.namespace</td><td colspan="1" class="confluenceTd">Some tests failed due to hash-dependent sequence orders</td><td colspan="1" class="confluenceTd">DONE: Ticket <a href="../../jira/browse/TNS-16.html" class="external-link" rel="nofollow">TNS-16</a> created, fix comitted.</td></tr><tr><td colspan="1" class="confluenceTd">tools.nrepl</td><td colspan="1" class="confluenceTd">Some tests failed due to hash-dependent sequence orders</td><td colspan="1" class="confluenceTd">DONE: Fixed with <a href="https://github.com/clojure/tools.nrepl/commit/93de0e0e9b60a4ee3e64918456055bc9f3760bcb" class="external-link" rel="nofollow">this commit</a>.</td></tr><tr><td colspan="1" class="confluenceTd"><a href="https://github.com/flatland/useful" class="external-link" rel="nofollow">useful</a></td><td colspan="1" class="confluenceTd">flatland.useful.deftype/defmap probably needs updating.  The namespace flatland.useful.map appears not to need any updates, as it uses Clojure maps but does not customize them at a low level that overrides the hash calculation.</td><td colspan="1" class="confluenceTd"> </td></tr></tbody></table></div>
    
        </div>

        <!--
<rdf:RDF xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
         xmlns:dc="http://purl.org/dc/elements/1.1/"
         xmlns:trackback="http://madskills.com/public/xml/rss/module/trackback/">
         <rdf:Description
    rdf:about="https://dev.clojure.org/display/design/Better+hashing"
    dc:identifier="https://dev.clojure.org/display/design/Better+hashing"
    dc:title="Better hashing"
    trackback:ping="https://dev.clojure.org/rpc/trackback/8192765"/>
</rdf:RDF>
-->

        <script type="text/x-template" title="labels-dialog-div">

    
    <div id="labels-dialog">
        <div class="labels-editor">
            <span class="errorMessage error" id="errorSpan"></span>
            <form method="GET" action="" id="add-labels-form">
                <div id="labelOperationErrorContainer">
                    <span class="error"><span class="errorMessage" id="labelOperationErrorMessage"></span></span>
                </div>
    
                <div class="caption">Enter labels to add to this page:</div>
                <div id="label-input-fields">
                    <input autocomplete="off" id="labelsString" name="labelsString" value="">
                    <input id="add-labels-editor-button" type="submit" class="add-labels" value="Add">
                </div>
                <div id="labelsAutocompleteList" class="aui-dd-parent resize-to-input" style="width: 417px"></div>
                <div id="dialog-label-list">
                    <span id="labels-section-title-none" class="no-labels-message" >
None
</span>
<ul class="label-list">
</ul>
                </div>
                <div id="waitImageAndStatus">
                    <img class="waiting" alt="Please wait" src="/s/en_GB/3047/3/_/images/icons/wait.gif">&nbsp;
                    <span id="labelOperationStatus" class="smalltext"></span>
                </div>
                <div class="labels-tip"></div>
            </form>
        </div>
    </div>
</script>
            
    


<div id="labels-section" class="pageSection group">
    <div class="labels-editor">
        <span id="labels-section-title" class="label-title">Labels:</span>
        <div id="labels-section-content" class="content-column">
            <span id="labels-section-title-none" class="no-labels-message" >
None
</span>
<ul class="label-list">
</ul>

                            <a id="labels-edit" href="#" class="show-labels-editor editor-icon" title="Edit Labels">
                    <span class="icon icon-edit">Edit Labels</span>
                </a>
                    </div>
    </div>
</div>

            
            




            
    







<div id="comments-section" class="pageSection group">
    
    
    
    
    </div>


            
</div>


    



    
    

    
    
    


    



    <br class="clear">
</div>
  
    </div>
</div>

<div id="footer">
                                                <p class="license license-opensource">
                  Powered by a free <b>Atlassian Confluence Open Source Project License</b> granted to Clojure. <a href="http://www.atlassian.com/c/conf/11461">Evaluate Confluence today</a>.<br>
                </p>
                        
    <ul id="poweredby">
        <li class="noprint">Powered by <a href="http://www.atlassian.com/software/confluence" class="hover-footer-link">Atlassian Confluence</a> <span id='footer-build-information'>4.0</span>, the <a href="http://www.atlassian.com/software/confluence/tour/enterprise-wiki.jsp" class="hover-footer-link">Enterprise Wiki</a></li>
        <li class="print-only">Printed by Atlassian Confluence 4.0, the Enterprise Wiki.</li>        
        <li class="noprint"> &nbsp; |&nbsp; <a href="http://jira.atlassian.com/secure/BrowseProject.jspa?id=10470" class="hover-footer-link">Report a bug</a></li>
        <li class="noprint"> &nbsp;|&nbsp; <a href="http://www.atlassian.com/about/connected.jsp?s_kwcid=Confluence-stayintouch" class="hover-footer-link">Atlassian News</a></li>
    </ul>

    

            <div><span style="">Site support by</span><a href="http://contegix.com"> <img style="vertical-align:middle" src="../../download/attachments/459015/contegix.jpg.html"/></a></div>
    </div></div>
</body>
</html>
